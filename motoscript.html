<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moto Scripts</title>
  <link rel="stylesheet" href="motoscript.css">
  <style>
    @font-face {
      font-family: Nakamoto;
      src: url('BabelStoneHanKana.woff') format('woff');
    }
  </style>
  <script src="cell.js"></script>
  <script>
    var neuralNet = {
      net: new Comment('neural-net'),
      push: function(channel, data){
        this.net.dispatchEvent(
          new CustomEvent(channel, {detail: data})
        )
      },
      pull: function(channel, compute){
        this.net.addEventListener(channel, compute)
      }
    }

    function animate({draw, delay}) {
      const start = performance.now() + delay;
      const duration = 1000
      const timing = function(t){
        return t < 0.5 ? 0.5 * Math.pow(2 * t, 2) : 0.5 * (2 - Math.pow(2 * (1 - t), 2))
      }
      requestAnimationFrame(function animate(time) {
        let timeFraction = (time - start) / duration
        if (timeFraction > 1) timeFraction = 1
        let progress = timing(timeFraction)
        draw(progress)
        if (timeFraction < 1) requestAnimationFrame(animate)
      })
    }
  </script>
  <script>
    var hueRange = 360
    var baseDelay = 1000
    var computeFraction = function(hex){
      return (1 - parseInt(hex, 16) / parseInt('100', 16))
    }
    var deriveScript = function(blockhash, index){
      var hex = blockhash.slice(index, index + 2)
      var hue = computeFraction(hex) * hueRange
      var delay = computeFraction(hex) * baseDelay
      return {
        hex: hex,
        hue: hue,
        delay: delay
      }
    }
    var motoscript = {
      $cell: true,
      $type: 'div',
      class: 'block',
      _blockhash: '',
      _fetch: function(){
        this._blockhash = '49998fa1363233eedf10464624de4fe0328918914c2131c30d6d9d7bb30d22d8'
      },
      $init: function(e) {
        this._blockhash = '000000000000000000019be4a382d8b5e46ae0a7100aed7f11b4d2d15cd7502b'
        window.setInterval(this._fetch.bind(this), 1000)
      },
      $update: function(e){
        // Push message through neural net
        neuralNet.push('blockhash', {
          blockhash: this._blockhash
        })
      },
      $components: [
        {
          $type: 'div',
          class: 'item',
          $components: [
            {
              $type: 'span',
              class: 'glyph',
              _index: 0,
              $init: function(e){
                neuralNet.pull('blockhash', function(event){
                  var scriptMetadata = deriveScript(event.detail.blockhash, this._index)
                  animate({
                    draw: function(progress){
                      this.style.opacity = (1 - progress) * 1
                    }.bind(this),
                    delay: scriptMetadata.delay
                  })
                }.bind(this))
              }
            }
          ]
        }
      ]
    }
  </script>
</head>
<body>
</body>
</html>
